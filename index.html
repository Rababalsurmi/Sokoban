<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="./css/style.css">
    <title>Sokoban</title>
</head>
<body onkeyup="handlekey(event)">
    <h1>Sokoban</h1>
    <div>
        <h3>Steps: <span id="spnStepsCount">0</span></h3>
    </div>
   <input type="text" id ="txtUsername" placeholder="Your Name Here"/>
   <button onclick="printBoard()">Print Board</button>
   <table id="tblBoard"></table> 


    <script>
        var WALL = "WALL";
        var FLOOR = "FLOOR";
        var TARGET = "TARGET";
        var PLAYER = "PLAYER";
        var BOX = "BOX";

        var gPlayerPos = {i: 2, j: 9};
        var gBoard = buildBoard();
       
        //var obj = {name: "Moshe", age: 25};
        //console.log(obj);
        
        
        function buildBoard(){
            //Create the Matrix
            var board = new Array(10);
            for (var i=0; i<board.length; i++){
                board[i] = new Array(12);
            }
            //Put FLOOR everywhere and WALL at the edges
            for (var i=0; i<board.length; i++)
            {
                for (var j=0; j<board[0].length; j++)
                {
                    var cell = {type: FLOOR, gameElement: null};
                    //if at edge
                    if( i == 0 || i == board.length-1 || j == 0 || j == board[0].length-1){
                        cell.type = WALL;
                    } 
                    board[i][j] = cell;
                }
            }
            //Put some TARGETS
            board[3][7].type = TARGET;
            board[5][7].type = TARGET;
            //Place the PLAYER
            board[gPlayerPos.i][gPlayerPos.j].gameElement = PLAYER;
            //Place the BOXES
            board[3][8].gameElement = BOX;
            board[7][4].gameElement = BOX;

            console.log(board);
            return board;
        }

        function printBoard(){
            var tblBoard = document.getElementById('tblBoard');
            var strHTML = '';

            for (var i=0; i<gBoard.length; i++)
            {
                strHTML += "<tr>";
                for (var j=0; j<gBoard[0].length; j++)
                {
                    var currentCell = gBoard[i][j];
                    var cellClass;
                    if(currentCell.type == FLOOR){
                        cellClass = "floor";
                    }else if(currentCell.type == WALL){
                        cellClass = "wall";
                    }else if(currentCell.type == TARGET){
                        cellClass = "target";
                    }
                    strHTML += "<td class = ' cell " + cellClass + " ' onclick='handleClick("+i+","+j+")' >";
                    
                    if(currentCell.gameElement == PLAYER){
                        strHTML += "<img src='./img/player.png'>"; 
                    }else if(currentCell.gameElement == BOX){
                        strHTML += "<img src='./img/box.png'>";
                    }   
                        
                    strHTML += "</td>";
                }
                strHTML += "</tr>";
            }
            tblBoard.innerHTML = strHTML;
        }

        function handleClick(i, j){
            var iDiff = i - gPlayerPos.i;
            var jDiff = j - gPlayerPos.j;
            var iAbsDiff = Math.abs(i - gPlayerPos.i);
            var jAbsDiff = Math.abs(j - gPlayerPos.j);

            // If the clicked cell is one of the 4 allowed
            if((iAbsDiff == 1 && jAbsDiff == 0) || (jAbsDiff == 1 && iAbsDiff == 0)){

                if(gBoard[i][j].type != WALL){
                    //console.log("Moving");

                    var canMove = true;

                    if(gBoard[i][j].gameElement == BOX){
                        //Can MOV if there is no WALL or other game element
                        if(gBoard[i+iDiff][j+jDiff].type != WALL && gBoard[i+iDiff][j+jDiff].gameElement == null){
                            //MOVE THE BOX
                            gBoard[i][j].gameElement = null;
                            gBoard[i+iDiff][j+jDiff].gameElement = BOX;
                        }else {
                            //can't move - there is a WALL behind the BOX
                            console.log("WALL Behind BOX");
                            canMove = false;
                        }
                        
                    }
                    if(canMove){
                        //MOVING
                        gBoard[gPlayerPos.i][gPlayerPos.j].gameElement = null;
                        gPlayerPos.i = i;
                        gPlayerPos.j = j;
                        gBoard[gPlayerPos.i][gPlayerPos.j].gameElement = PLAYER;

                        //Update steps count
                        var spnStepsCount = document.getElementById('spnStepsCount');
                        spnStepsCount.innerHTML++;

                        printBoard();
                        checkVictory();
                    }
                    
                }


            }//else console.log("TOO FAR", iAbsDiff, jAbsDiff);
            

        }

        function checkVictory(){
            var isVictory = true;
            for(var i=0; i<gBoard.length; i++){
                for(var j=0; j<gBoard[0].length; j++){
                    var currentCell =gBoard[i][j];
                    if(currentCell.type == TARGET && currentCell.gameElement != BOX) isVictory = false;
                }  
            }
            if(isVictory) alert("You Won!")
        }

        function handlekey(event){
            //console.log(event.keyCode, event.key);

            var i = gPlayerPos.i;
            var j = gPlayerPos.j;

            switch(event.keyCode){
                case 37: 
                    handleClick(i, j-1);
                break;
                case 39: 
                    handleClick(i, j+1);
                break;
                case 38: 
                    handleClick(i-1, j);
                break;
                case 40: 
                    handleClick(i+1, j);
                break;

            }
        }
        
    </script>
    
</body>

</html>